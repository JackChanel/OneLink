# OneLink 远程开机棒
## 项目来源
嵌入式开发课程手搓，浅浅窥探一下物联网开发。代码中相关的秘钥参数全已失效，需要自行参照Read么申请使用。
- Vue3是移动端远程开机管理面板
- NodeApp是阿里云函数代码
- src中是esp8266开机棒源码

## 功能概述

OneLink 开机棒是一款基于 **ESP8266** 开发的智能设备，旨在为局域网中支持 **Wake-on-LAN (WOL)** 功能的主机提供便捷的远程开机服务。用户无需在主机上安装任何额外的驱动程序，只需对开机棒进行简单配置，即可实现远程启动主机的功能。

### 核心功能

**1. 远程开机**
- **WOL 协议支持**：开机棒利用 **WOL** 协议，通过发送特定的 **Magic Packet** 来唤醒局域网内的主机。
- **多主机管理**：支持同时管理多台主机，用户可根据需求配置不同的主机信息。

**2. 网络配置**
- **Wi-Fi 连接**：开机棒通过 **ESP8266** 的 Wi-Fi 模块连接到局域网，确保与目标主机处于同一网络环境。
- **AP 模式**：首次使用时，开机棒可进入 **AP** 模式，创建热点供用户进行初始配置。

**3. 用户界面**
- **Web 配置页面**：提供直观的 **Web** 配置界面，用户可通过浏览器轻松完成设备设置。
- **移动端支持**：适配移动设备，方便用户随时随地进行管理。



## 原理细节

**开机棒工作图**
![开机棒初始化启动](https://cdn.nlark.com/yuque/0/2024/png/1728867/1711034339401-2d0d229a-68e2-4bd0-9b51-86f2a3797802.png)

**N01:初始化配置**
1. 初始化文件系统
2. 创建配置文件`config.json`
3. 创建配置网页端文件

**N02:启动网页配置页**
1. 以AP模式启动
2. 配置DNS，使用固定域名访问AP的IP地址
3. 用户访问网页
4. 输入相关配置信息`ssid`、`password`等
5. 如果连接成功，在配置中加入`wifi:true`

**LED状态机图**

![LED状态机图](https://cdn.nlark.com/yuque/0/2024/png/1728867/1714057831914-5a44d684-3844-4fdb-aa81-29c57248c7df.png)



## 使用流程
**1. 网卡配置**

WOL 一般对有线网卡提供支持，自行百度解决

**2.公网方案**

设备支持局域网远程开机，如果需要公网方案，建议使用阿里云平台

具体配置流程：

一、使用`MQTT.fx`模拟终端设备，测试阿里云物联网平台MQTT相关协议的连通性。

二、分别获取`ESP8266 SDK`和`Node SDK`用于开发板、Web应用的MQTT连接。

三、根据`SDK`提供的接口，完成适配业务逻辑的开发。

### 阿里云物联网平台的配置
首先需要明确平台上涉及的两个概念的含义：

产品：指的是同类型设备的集合，你的各个物联网设备终端需要相互协作完成某一项功能，涉及的各个设备都归入一个产品的管辖范围。一个产品内的设备可以方便的通信。

设备：指的是接入平台的设备，从底层角度来看，就是各个安装了阿里云物联网SDK的软件。

#### 产品创建
![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716623960851-80f73e51-ad28-46ab-a51c-dbd31424a0b2.png)

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716624029229-32406675-8a50-4536-8033-2424524cbdf6.png)

#### 产品功能定义
这部分的功能是定义各个设备之间数据互传的总体设计。比如需要在APP上远程控制开发板的开关灯，就需要在这里定义一个开关灯的控制字段（物模型）。

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716624158377-30d4e72d-2a30-4d9a-a0c1-e60b6ad94e71.png)

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716624214456-bd729982-e984-44a0-8398-5e796b1b18ba.png)

设计完成相关功能后，需要发布上线。

#### 设备创建
设备是需要绑定在一个产品下的

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716624312976-cfd74c59-cdb7-4ff3-a23a-3fae5461a6b2.png)

创建好的设备会提供一个设备的入网信息，分别在设备信息中可以查看

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716624414156-bfb9d740-86f3-4e06-ac22-608fffbf7e64.png)

这是ESP8266设备的相关信息，还需要创建一个Node端的设备

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716624482518-d93bcb0a-01d9-4355-be0c-8673f25285b7.png)

现在就完成了云平台上关于两个设备的注册，其实就是给出了设备各自的MQTT连接地址和账号密码，在使用各终端SDK时，填入这些参数就可以在阿里云平台的入网。

#### 数据互通
上面的步骤只是实现了设备的入网，但各自并不能相互通信。通过配置消息转发下的云产品流转功能即可实现各设备相互通信。这里涉及三个概念

1. 数据源：数据提供者
2. 数据目的：数据接受者
3. 解析器：提供者给出的数据如何处理后转发给接受者的脚本规则

首先创建数据源，然后在数据源中添加`topic`这里的`topic`就是MQTT协议里提到的`topic`，它是一个数据通道的名字。选择物模型数据上报作为数据源类型。

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716626077002-12fe4624-1b0a-4caf-b606-83e64f3971e7.png)

数据目的的设置，表示的是数据的订阅方所在的消息接收器。这里选择另一个`topic`作为目的即可。

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716626240253-ad30f4d6-812b-4366-b70d-37a50e6c551f.png)

再创建一个解析器

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716626330285-0ace5d84-ca7c-4175-aff9-824b16d46fb2.png)

在解析器中配置数据源和数据目的的连接方式。数据源选择开发板，目的选择NodeAPP。

解析器脚本编辑为

```javascript
// 设备上报数据内容
var data = payload();

// 流转到另一个Topic（数据目的ID，数据目的所订阅的topic，数据值）
// topic中的deviceName在设备信息中可以查看
writeIotTopic(1002, '/sys/a1tDX2MnsvW/Node/thing/service/property/set', data);
```

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716626572539-9e116421-4d6c-41f2-bc85-e22cb254286a.png)

编辑完成后发布。

在解析器页面启动解析器。这样就实现了开发板的消息发布后，Node可以接收到消息。

### 使用MQTT.fx调试
MQTT.fx是一款MQTT协议调试软件，可以测试MQTT连接的有效性，支持消息发布与订阅。

1. 配置连接

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716626937572-4d6a4a20-e932-4254-88ef-5e01ee30a38e.png)

2. 添加设备

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716626990081-a83b7f2b-4341-40fa-9da3-5d7c5780e51c.png)

在阿里云平台设备的MQTT连接参数中找到对应参数并填入

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716627062437-2cf543f9-c9fa-44ca-a5e4-ba90178251a3.png)

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716627102042-3ecd3b60-215b-4618-bd99-de5b085bd22d.png)

点击Apply后，点OK，在主界面点击连接

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716627144054-2a37697d-d0f9-4fca-bd00-8420781e8e37.png)

就入网了。输入开发板的发布topic：`'/sys/a1tDX2MnsvW/<font style="color:rgb(17, 17, 17);">ESP8266</font>/thing/service/property/post'`（换成自己的）

在下面空白框中填写发送的信息`{"id":"123","version":"1.0","params":{"LED_STATUS":1},"method":"thing.event.property.post"}`  
你需要改的地方是，将`LED_STATUS`换成你刚刚编辑的物模型的标志符

![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716627394001-83af1cce-a1fc-4d37-bc09-5e0a52eca9d2.png)

然后推送。

相同方式再开启一个MQTT.fx，输入Node的MQTT连接。在订阅栏中填入对应的订阅Topic。在开发板的MQTT.fx中点击发布，观察到Node的MQTT.fx可以收到消息。![](https://cdn.nlark.com/yuque/0/2024/png/1728867/1716628532155-2601c7df-6bb6-48eb-b538-4d9b16b493c1.png)

完成验证工作。

### SDK集成工作
分别在各软件端中引入MQTT的SDK或者阿里云集成的SDK，配置相关MQTT参数即可实现通信。

